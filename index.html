<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Camera & Mic Test — Safe Capture</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; padding: 18px; max-width: 900px; margin: auto; }
    h1 { font-size: 1.4rem; margin-bottom: 8px; }
    video { width: 100%; max-width: 640px; border-radius: 8px; background: #000; }
    .controls { margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .preview { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .thumb { max-width:200px; border:1px solid #ddd; padding:6px; border-radius:6px; background:#fff; }
    small { color:#555; display:block; margin-top:6px; }
    label { display:block; margin-top:12px; }
    input[type="text"] { width:100%; padding:6px 8px; border-radius:6px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Camera & Microphone Test (Safe)</h1>
  <p>এই পেজটি কেবল আপনার অনুমতিতে কাজ করবে। ক্যামেরা/মাইকের ডাটা **কখনোই স্বয়ংক্রিয়ভাবে পাঠানো হবে না**—প্রতিবার আপনাকে ক্লিক করতে হবে।</p>

  <video id="preview" autoplay playsinline muted></video>

  <div class="controls">
    <button id="btnStart">Start Camera & Mic</button>
    <button id="btnStop" disabled>Stop</button>
    <button id="btnSnap" disabled>Capture Snapshot</button>
    <button id="btnRecord" disabled>Record 5s Audio</button>
    <button id="btnSend" disabled>Send Latest to Server</button>
  </div>

  <label>
    Server upload URL (POST) — আপনার সার্ভারের এন্ডপয়েন্ট দিন:
    <input id="serverUrl" type="text" placeholder="https://your-server.example.com/upload" />
  </label>

  <div class="preview" id="previewArea">
    <!-- captured thumbnail + audio controls will appear here -->
  </div>

  <script>
    const preview = document.getElementById('preview');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnSnap = document.getElementById('btnSnap');
    const btnRecord = document.getElementById('btnRecord');
    const btnSend = document.getElementById('btnSend');
    const previewArea = document.getElementById('previewArea');
    const serverUrlInput = document.getElementById('serverUrl');

    let mediaStream = null;
    let latestImageBlob = null;
    let latestAudioBlob = null;
    let mediaRecorder = null;
    let audioChunks = [];

    btnStart.onclick = async () => {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        preview.srcObject = mediaStream;
        btnStart.disabled = true;
        btnStop.disabled = false;
        btnSnap.disabled = false;
        btnRecord.disabled = false;
        console.log('Media started');
      } catch (err) {
        alert('permission denied or no device: ' + err.message);
      }
    };

    btnStop.onclick = () => {
      if (mediaStream) {
        for (const track of mediaStream.getTracks()) track.stop();
        preview.srcObject = null;
        mediaStream = null;
      }
      btnStart.disabled = false;
      btnStop.disabled = true;
      btnSnap.disabled = true;
      btnRecord.disabled = true;
      console.log('Media stopped');
    };

    btnSnap.onclick = () => {
      if (!mediaStream) return alert('Start camera first');
      const videoTrack = mediaStream.getVideoTracks()[0];
      const settings = videoTrack.getSettings ? videoTrack.getSettings() : {};
      const w = preview.videoWidth || (settings.width || 640);
      const h = preview.videoHeight || (settings.height || 480);

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(blob => {
        latestImageBlob = blob;
        showPreview();
      }, 'image/jpeg', 0.85);
    };

    btnRecord.onclick = async () => {
      if (!mediaStream) return alert('Start camera & mic first');
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        return;
      }

      audioChunks = [];
      mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        latestAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        showPreview();
      };
      mediaRecorder.start();
      btnRecord.textContent = 'Recording... (auto stop 5s)';
      btnRecord.disabled = true;

      setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        btnRecord.disabled = false;
        btnRecord.textContent = 'Record 5s Audio';
      }, 5000);
    };

    function showPreview() {
      previewArea.innerHTML = '';
      if (latestImageBlob) {
        const img = document.createElement('img');
        img.className = 'thumb';
        img.alt = 'snapshot';
        img.src = URL.createObjectURL(latestImageBlob);
        const dl = document.createElement('a');
        dl.href = img.src;
        dl.download = 'snapshot.jpg';
        dl.textContent = 'Download Image';
        dl.style.display = 'block';
        previewArea.appendChild(img);
        previewArea.appendChild(dl);
      }
      if (latestAudioBlob) {
        const audioURL = URL.createObjectURL(latestAudioBlob);
        const audioEl = document.createElement('audio');
        audioEl.controls = true;
        audioEl.src = audioURL;
        previewArea.appendChild(audioEl);
        const dl2 = document.createElement('a');
        dl2.href = audioURL;
        dl2.download = 'recording.webm';
        dl2.textContent = 'Download Audio';
        dl2.style.display = 'block';
        previewArea.appendChild(dl2);
      }
      btnSend.disabled = !(latestImageBlob || latestAudioBlob);
    }

    btnSend.onclick = async () => {
      const serverUrl = serverUrlInput.value.trim();
      if (!serverUrl) return alert('Please provide your server upload URL first.');
      if (!latestImageBlob && !latestAudioBlob) return alert('No image or audio to send.');

      const fd = new FormData();
      if (latestImageBlob) fd.append('photo', latestImageBlob, 'snapshot.jpg');
      if (latestAudioBlob) fd.append('voice', latestAudioBlob, 'recording.webm');
      // optional metadata
      fd.append('note', 'User-initiated upload from local test page');
      try {
        btnSend.disabled = true;
        btnSend.textContent = 'Uploading...';
        const res = await fetch(serverUrl, { method: 'POST', body: fd });
        if (!res.ok) throw new Error('Upload failed: ' + res.status);
        const json = await res.json();
        alert('Server response: ' + JSON.stringify(json));
      } catch (err) {
        alert('Upload error: ' + err.message);
      } finally {
        btnSend.disabled = false;
        btnSend.textContent = 'Send Latest to Server';
      }
    };

    // warn user if leaving while recording
    window.addEventListener('beforeunload', e => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>
